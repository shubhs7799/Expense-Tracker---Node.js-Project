<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reset Password - Expense Tracker</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container auth-container">
    <div style="text-align: center; margin-bottom: 2rem;">
      <div style="font-size: 3rem; margin-bottom: 0.5rem;">üîê</div>
      <h2>Reset Your Password</h2>
      <p style="color: #7f8c8d; margin-bottom: 2rem;">Enter your new password below</p>
    </div>
    
    <!-- Loading State -->
    <div id="loading-state" style="text-align: center; padding: 20px;">
      <div class="loading" style="margin: 0 auto 15px;"></div>
      <p style="color: #7f8c8d;">Verifying reset token...</p>
    </div>

    <!-- Invalid Token State -->
    <div id="invalid-token-state" style="display: none; text-align: center; padding: 20px;">
      <div style="font-size: 2rem; color: #e74c3c; margin-bottom: 15px;">‚ùå</div>
      <h3 style="color: #e74c3c; margin-bottom: 10px;">Invalid or Expired Link</h3>
      <p style="color: #7f8c8d; margin-bottom: 20px;">This password reset link is invalid or has expired.</p>
      <a href="forgot-password.html" style="display: inline-block; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: 600;">
        Request New Reset Link
      </a>
    </div>
    
    <!-- Reset Form -->
    <form id="resetPasswordForm" style="display: none;">
      <div id="user-info" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
        <p style="margin: 0; color: #2c3e50; font-weight: 600;">Resetting password for:</p>
        <p id="user-email" style="margin: 5px 0 0 0; color: #667eea; font-weight: 600;"></p>
      </div>

      <div style="position: relative;">
        <input type="password" id="newPassword" placeholder="   New Password (min 7 characters)" required style="padding-left: 45px;" minlength="7" />
        <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #95a5a6;">üîí</span>
      </div>
      
      <div style="position: relative;">
        <input type="password" id="confirmPassword" placeholder="   Confirm New Password" required style="padding-left: 45px;" minlength="7" />
        <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #95a5a6;">üîê</span>
      </div>

      <!-- Password Strength Indicator -->
      <div id="password-strength" style="margin: 10px 0; font-size: 0.9rem;">
        <div id="strength-text" style="color: #7f8c8d;"></div>
        <div id="strength-bar" style="height: 4px; background: #e9ecef; border-radius: 2px; margin-top: 5px;">
          <div id="strength-fill" style="height: 100%; border-radius: 2px; width: 0%; transition: all 0.3s ease;"></div>
        </div>
      </div>
      
      <button type="submit">
        <span>Reset Password</span>
      </button>
      
      <div style="text-align: center; margin-top: 1.5rem;">
        <p style="color: #7f8c8d;">Remember your password? 
          <a href="login.html" style="font-weight: 600;">Sign in here</a>
        </p>
      </div>
    </form>

    <!-- Success State -->
    <div id="success-state" style="display: none; text-align: center; padding: 20px;">
      <div style="font-size: 3rem; color: #27ae60; margin-bottom: 15px;">‚úÖ</div>
      <h3 style="color: #27ae60; margin-bottom: 10px;">Password Reset Successful!</h3>
      <p style="color: #7f8c8d; margin-bottom: 20px;">Your password has been successfully reset. You can now log in with your new password.</p>
      <a href="login.html" style="display: inline-block; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: 600;">
        Go to Login
      </a>
    </div>
    
    <div class="error" id="resetPasswordError" style="display: none;"></div>
  </div>

  <script>
    const baseURL = '/api/v1';
    let resetToken = null;

    function showError(message) {
      const errorElement = document.getElementById('resetPasswordError');
      errorElement.textContent = message;
      errorElement.style.display = 'block';
      setTimeout(() => {
        errorElement.style.display = 'none';
      }, 5000);
    }

    function checkPasswordStrength(password) {
      const strengthText = document.getElementById('strength-text');
      const strengthFill = document.getElementById('strength-fill');
      
      let strength = 0;
      let text = '';
      let color = '';

      if (password.length >= 7) strength += 1;
      if (password.match(/[a-z]/)) strength += 1;
      if (password.match(/[A-Z]/)) strength += 1;
      if (password.match(/[0-9]/)) strength += 1;
      if (password.match(/[^a-zA-Z0-9]/)) strength += 1;

      switch (strength) {
        case 0:
        case 1:
          text = 'Very Weak';
          color = '#e74c3c';
          break;
        case 2:
          text = 'Weak';
          color = '#f39c12';
          break;
        case 3:
          text = 'Fair';
          color = '#f1c40f';
          break;
        case 4:
          text = 'Good';
          color = '#27ae60';
          break;
        case 5:
          text = 'Strong';
          color = '#2ecc71';
          break;
      }

      strengthText.textContent = `Password Strength: ${text}`;
      strengthText.style.color = color;
      strengthFill.style.backgroundColor = color;
      strengthFill.style.width = `${(strength / 5) * 100}%`;
    }

    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    resetToken = urlParams.get('token');

    if (!resetToken) {
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('invalid-token-state').style.display = 'block';
    } else {
      // Verify token
      fetch(`${baseURL}/verify-reset-token/${resetToken}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('loading-state').style.display = 'none';
          
          if (data.success) {
            document.getElementById('resetPasswordForm').style.display = 'block';
            document.getElementById('user-email').textContent = data.data.email;
          } else {
            document.getElementById('invalid-token-state').style.display = 'block';
          }
        })
        .catch(err => {
          document.getElementById('loading-state').style.display = 'none';
          document.getElementById('invalid-token-state').style.display = 'block';
        });
    }

    // Password strength checker
    const newPasswordInput = document.getElementById('newPassword');
    if (newPasswordInput) {
      newPasswordInput.addEventListener('input', (e) => {
        checkPasswordStrength(e.target.value);
      });
    }

    // Form submission
    const resetPasswordForm = document.getElementById('resetPasswordForm');
    if (resetPasswordForm) {
      resetPasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
          showError('Passwords do not match');
          return;
        }

        const submitBtn = resetPasswordForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;

        try {
          submitBtn.innerHTML = '<div class="loading"></div> Resetting...';
          submitBtn.disabled = true;

          const res = await fetch(`${baseURL}/reset-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              token: resetToken, 
              newPassword, 
              confirmPassword 
            }),
          });

          const data = await res.json();
          
          if (res.ok) {
            document.getElementById('resetPasswordForm').style.display = 'none';
            document.getElementById('success-state').style.display = 'block';
          } else {
            throw new Error(data.message);
          }

        } catch (err) {
          showError(err.message);
        } finally {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      });
    }
  </script>
</body>
</html>
